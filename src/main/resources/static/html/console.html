<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>控制台</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon" />
    
    <link rel="stylesheet" href="../css/font.css">
    <link rel="stylesheet" href="../layui/css/layui.css">
    <link rel="stylesheet" href="../css/xadmin.css">

    <script src="../js/cookieTool.js"></script>
    <script src="../js/jquery.min.js"></script>
    <script src="../js/echarts.min.js"></script>
</head>
<body>
<div class="x-body layui-anim layui-anim-up">

    <fieldset class="layui-elem-field">
        <legend>设备控制</legend>
        <div class="layui-field-box">
            <div class="layui-col-md12">
               <div style="margin-bottom: 15px;margin-left: 15px">
                   <button id="openDoor" class="layui-btn layui-btn-primary" onclick="openDoor()"><p style="color:#077e37">打开门阀</p></button>

                   <button id="closeDoor" class="layui-btn layui-btn-primary" onclick="closeDoor()"><p style="color:#077e37">关闭门阀</p></button>

                   <button id="resetDevice" class="layui-btn layui-btn-primary" onclick="resetDevice()"><p style="color:#077e37">复位设备</p></button>

                   <button id="cleanLog" class="layui-btn layui-btn-primary" onclick="cleanDevice()"><p style="color:#077e37">清理内存</p></button>

                   <button id="readCard" class="layui-btn layui-btn-primary" onclick="readCard()"><p style="color:#077e37">读取卡号</p></button>
               </div>
            </div>
        </div>
    </fieldset>

    <fieldset class="layui-elem-field">
        <legend>设备状态</legend>
        <div class="layui-field-box">
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-body">
                        <div class="layui-carousel x-admin-carousel x-admin-backlog" lay-anim="" lay-indicator="inside" lay-arrow="none" style="width: 100%; height: 90px;">
                            <div carousel-item="">
                                <ul class="layui-row layui-col-space10 layui-this">
                                    <li class="layui-col-xs2">
                                        <div class="x-admin-backlog-body">
                                            <h3>连接状态</h3>
                                            <p><cite id="connectState">未连接</cite></p>
                                        </div>
                                    </li>

                                    <li class="layui-col-xs2">
                                        <div class="x-admin-backlog-body">
                                            <h3>门阀状态</h3>
                                            <p><cite id="doorState">未知</cite></p>
                                        </div>
                                    </li>
                                    <li class="layui-col-xs2">
                                        <div class="x-admin-backlog-body">
                                            <h3>读卡器状态</h3>
                                            <p><cite id="rfidState">未知</cite></p>
                                        </div>
                                    </li>
                                    <li class="layui-col-xs2">
                                        <div class="x-admin-backlog-body">
                                            <h3>光栅状态</h3>
                                            <p><cite id="graState">未知</cite></p>
                                        </div>
                                    </li>
                                    <li class="layui-col-xs2">
                                        <div class="x-admin-backlog-body">
                                            <h3>开关状态</h3>
                                            <p><cite id="touchState">未知</cite></p>
                                        </div>
                                    </li>
                                    <li class="layui-col-xs2">
                                        <div class="x-admin-backlog-body">
                                            <h3>环境数据采集模块状态</h3>
                                            <p><cite id="enviroState">未知</cite></p>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </fieldset>

    <fieldset class="layui-elem-field">
        <legend>数据统计</legend>
        <div class="layui-field-box">
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-body">
                        <div class="layui-carousel x-admin-carousel x-admin-backlog" lay-anim="" lay-indicator="inside" lay-arrow="none" style="width: 100%; height: 90px;">
                            <div carousel-item="">
                                <ul class="layui-row layui-col-space10 layui-this">
                                    <li class="layui-col-xs2">
                                        <div class="x-admin-backlog-body">
                                            <h3>总设备数</h3>
                                            <p><cite id="deviceTotalCount">未知</cite></p>
                                        </div>
                                    </li>
                                    <li class="layui-col-xs2">
                                        <div class="x-admin-backlog-body">
                                            <h3>总用户数</h3>
                                            <p><cite id="userTotalCount">未知</cite></p>
                                        </div>
                                    </li>
                                    <li class="layui-col-xs2">
                                        <div class="x-admin-backlog-body">
                                            <h3>通行次数</h3>
                                            <p><cite id="passTotalCount">未知</cite></p>
                                        </div>
                                    </li>
                                    <li class="layui-col-xs2">
                                        <div class="x-admin-backlog-body">
                                            <h3>当前温度</h3>
                                            <p><cite id="currentTemperature">未知</cite></p>
                                        </div>
                                    </li>
                                    <li class="layui-col-xs2">
                                        <div class="x-admin-backlog-body">
                                            <h3>当前湿度</h3>
                                            <p><cite id="currentHumidity">未知</cite></p>
                                        </div>
                                    </li>
                                    <li class="layui-col-xs2">
                                        <div class="x-admin-backlog-body">
                                            <h3>当前光强</h3>
                                            <p><cite id="currentLight">未知</cite></p>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </fieldset>

    <fieldset class="layui-elem-field">
        <legend>今日温度曲线</legend>
        <div class="layui-field-box">
            <div id="temperatureCurve" style="width: 100%;height:300px;"></div>
        </div>
    </fieldset>

    <fieldset class="layui-elem-field">
        <legend>今日湿度曲线</legend>
        <div class="layui-field-box">
            <div id="humidityCurve" style="width: 100%;height:300px;"></div>
        </div>
    </fieldset>

    <fieldset class="layui-elem-field">
        <legend>今日光强曲线</legend>
        <div class="layui-field-box">
            <div id="lightIntensityCurve" style="width: 100%;height:300px;"></div>
        </div>
    </fieldset>

    <fieldset class="layui-elem-field">
        <legend>设备信息</legend>
        <div class="layui-field-box">
            <table class="layui-table">
                <tbody>
                <tr>
                    <th>设备编号</th>
                    <td id="deviceNumber"></td>
                </tr>
                <tr>
                    <th>设备名称</th>
                    <td id="deviceName"></td>
                </tr>
                <tr>
                    <th>操作系统</th>
                    <td id="osName"></td>
                </tr>
                <tr>
                    <th>运行环境</th>
                    <td id="runTimeEnviro"></td>
                </tr>
                <tr>
                    <th>内存大小</th>
                    <td id="memorySize"></td>
                </tr>
                <tr>
                    <th>剩余内存</th>
                    <td id="remainderMemory"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </fieldset>

</div>
<script>
    //WebSocket相关
    var webSocketUrl="ws://"+document.location.host+"/LocalService";
    var webSocket=null;
    var webSocketIsReady=false;
    var msgRouteToService=null;
    var msgRouteToDevice=null;
    //var msgSendModel={msgRoute:'',code:'',msg:'',data:''};

    var rfidAdmin=null;

    $(document).ready(function () {
        rfidAdmin=JSON.parse(getCookie("rfidAdmin"));
        if (rfidAdmin==null){
            window.location.href="http://"+document.location.host+"/index.html";
            return;
        }
        //建立与服务器的WebSocket连接
        if ("WebSocket" in window){
            try {
                // 新建一个socket
                webSocket = new WebSocket(webSocketUrl);
                // 连接诶已建立
                webSocket.onopen=onWebSocketOpen;
                //收到消息
                webSocket.onmessage=onWebSocketMessage;
                //连接断开
                webSocket.onclose=onWebSocketClose;
                //发送异常
                webSocket.onerror=onWebSocketError;
            }catch (err) {
                alert(err);
            }
        }else {
            alert("您的浏览器不支持WebSocket!无法与设备建立实时连接！");
        }
        //获取系统总设备数
        $.get("http://"+document.location.host+"/getDeviceCount",function (data,status) {
            if (status=='success'){
                if (data.code==0){
                    $("#deviceTotalCount").text(data.data);
                }else {
                    alert(data.msg);
                }
            } else {
                alert(status);
            }
        });
        //获取系统总用户数
        $.get("http://"+document.location.host+"/getUserCount",function (data,status) {
            if (status=='success'){
                if (data.code==0){
                    $("#userTotalCount").text(data.data);
                }else {
                    alert(data.msg);
                }
            } else {
                alert(status);
            }
        });
        //获取当前设备的通行记录次数
        $.get("http://"+document.location.host+"/getRecordCountByDeviceNumber",{deviceNumber:rfidAdmin.deviceNumber},function (data,status) {
            if (status=='success'){
                if (data.code==0){
                    $("#passTotalCount").text(data.data);
                }else {
                    alert(data.msg);
                }
            } else {
                alert(status);
            }
        });
        //初始化echarts实例
        temperatureCurve = echarts.init(document.getElementById('temperatureCurve'));
        humidityCure=echarts.init(document.getElementById('humidityCurve'));
        lightIntensityCurve=echarts.init(document.getElementById('lightIntensityCurve'));
        // 指定图表的配置项和数据
        temperatureOption = {
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data:['温度']
            },
            grid: {
                left: '1%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            toolbox: {
                feature: {
                    saveAsImage: {}
                }
            },
            xAxis: {
                type: 'category',
                boundaryGap: false,
                data: ['周一','周二','周三','周四','周五','周六','周日']
            },
            yAxis: {
                type: 'value'
            },
            series: [
                {
                    name:'温度',
                    type:'line',
                    stack: '摄氏度',
                    data:[120, 132, 101, 134, 90, 230, 210]
                }
            ]
        };
        humidityOption = {
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data:['湿度']
            },
            grid: {
                left: '1%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            toolbox: {
                feature: {
                    saveAsImage: {}
                }
            },
            xAxis: {
                type: 'category',
                boundaryGap: false,
                data: ['周一','周二','周三','周四','周五','周六','周日']
            },
            yAxis: {
                type: 'value'
            },
            series: [
                {
                    name:'湿度',
                    type:'line',
                    stack: '百分比',
                    data:[120, 132, 101, 134, 90, 230, 210]
                }
            ]
        };
        lightIntensityOption= {
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data:['光强']
            },
            grid: {
                left: '1%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            toolbox: {
                feature: {
                    saveAsImage: {}
                }
            },
            xAxis: {
                type: 'category',
                boundaryGap: false,
                data: ['周一','周二','周三','周四','周五','周六','周日']
            },
            yAxis: {
                type: 'value'
            },
            series: [
                {
                    name:'光强',
                    type:'line',
                    stack: '勒克斯',
                    data:[120, 132, 101, 134, 90, 230, 210]
                }
            ]
        };
        //获取当日的环境数据
        getCurrentDayEnvirDataForEcharts();
    });

    function onWebSocketOpen(event){
        webSocketIsReady=true;
        //创建消息路由
        msgRouteToService={to:"LocalService",from:"A"+rfidAdmin.deviceNumber};
        msgRouteToDevice={to:"D"+rfidAdmin.deviceNumber,from:"A"+rfidAdmin.deviceNumber};
        //发送身份验证消息
        sendMsgByWebSocket({route:msgRouteToService,code:18,msg:"上传身份信息！",data:''})
    }

    function onWebSocketError(event) {
        webSocketIsReady=false;
    }

    function onWebSocketClose(closeEvent){
        webSocketIsReady=false;
        $('#connectState').text("未连接");
        $('#doorState').text("未知");
        $('#rfidState').text("未知");
        $('#graState').text("未知");
        $('#touchState').text("未知");
        $('#enviroState').text("未知");

        $('#currentTemperature').text("未知");
        $('#currentHumidity').text("未知");
        $('#currentLight').text("未知");
        alert("与设备的连接中断");
    }

    function onWebSocketMessage(messageEvent){
        var message = JSON.parse(messageEvent.data);
        var msgData = null;
        if (message.data !== "") {
            msgData=JSON.parse(message.data);
        }
        switch (message.code) {
            case 24://设备传送门禁状态数据成功
                $('#connectState').text("已连接");
                $('#doorState').text(msgData.doorState);
                $('#rfidState').text(msgData.rfidState);
                $('#graState').text(msgData.graState);
                $('#touchState').text(msgData.touchState);
                $('#enviroState').text(msgData.enviroState);
                break;
            case 25://设备传送门禁状态数据失败
                $('#connectState').text("已连接");
                $('#doorState').text("未知");
                $('#rfidState').text("未知");
                $('#graState').text("未知");
                $('#touchState').text("未知");
                $('#enviroState').text("未知");
                alert("获取设备状态异常！");
                break;
            case 21://设备传送环境数据成功！
                $('#currentTemperature').text(msgData.temperature+"℃");
                $('#currentHumidity').text(msgData.humidity+"%");
                $('#currentLight').text(msgData.lightIntensity+"Lux");
                getCurrentDayEnvirDataForEcharts();
                break;
            case 22://设备传送环境数据失败！
                $('#currentTemperature').text("未知");
                $('#currentHumidity').text("未知");
                $('#currentLight').text("未知");
                alert("获取实时环境数据异常！");
                //通知设备上状态信息
                updataDeviceState();
                break;
            case 17://设备传送卡片数据成功！
                alert("卡号："+msgData.userCard);
                break;
            case 16://设备上传卡片数据失败！
                alert("读卡失败！");
                break;
            case 4://开门成功！
                $('#doorState').text("开启");
                break;
            case 3://开门失败！
                alert("开门失败！");
                //通知设备上状态信息
                updataDeviceState();
                break;
            case 7://关门成功
                $('#doorState').text("关闭");
                break;
            case 6://关门失败！
                alert("关门失败！");
                //通知设备上状态信息
                updataDeviceState();
                break;
            case 11://复位设备成功
                alert("复位设备成功！");
                //通知设备上状态信息
                updataDeviceState();
                break;
            case 10://复位设备失败！
                alert("复位设备失败！");
                //通知设备上状态信息
                updataDeviceState();
                break;
            case 14://清理日志成功！
                alert("清理日志成功！");
                //通知设备上状态信息
                updateDeviceInfor();
                break;
            case 13://清理日志失败！
                alert("清理日志失败！");
                //通知设备上传设备信息
                updateDeviceInfor();
                break;
            case 20://身份验证成功！
                //do something
                break;
            case 19://身份验证失败！
                alert("连接服务器失败！");
                break;
            case 33://设备上传设备信息成功
                //do something
                $('#deviceNumber').text(msgData.deviceNumber);
                $('#deviceName').text(msgData.deviceName);
                $('#osName').text(msgData.osName);
                $('#runTimeEnviro').text(msgData.runTimeEnviro);
                $('#memorySize').text(msgData.memorySize);
                $('#remainderMemory').text(msgData.remainderMemory);
                break;
            case 35://设备上传设备信息失败
                $('#deviceNumber').text("未知");
                $('#deviceName').text("未知");
                $('#osName').text("未知");
                $('#runTimeEnviro').text("未知");
                $('#memorySize').text("未知");
                $('#remainderMemory').text("未知");
                alert("获取设备信息失败！");
                break;
            case 101://设备已连接（来自服务器的消息通知）
                updataDeviceState();
                updateEnviroData();
                updateDeviceInfor();
                break;
            case 100://设备连接断开（来自服务器的消息通知）
                $('#connectState').text("已断开");
                $('#doorState').text("未知");
                $('#rfidState').text("未知");
                $('#graState').text("未知");
                $('#touchState').text("未知");
                $('#enviroState').text("未知");
                $('#currentTemperature').text("未知");
                $('#currentHumidity').text("未知");
                $('#currentLight').text("未知");
                $('#deviceNumber').text("未知");
                $('#deviceName').text("未知");
                $('#osName').text("未知");
                $('#runTimeEnviro').text("未知");
                $('#memorySize').text("未知");
                $('#remainderMemory').text("未知");
            default:
                break;
        }
    }

    function sendMsgByWebSocket(msg){
        if (webSocket!=null&&webSocketIsReady)
            webSocket.send(JSON.stringify(msg));
    }

    function openDoor() {
        sendMsgByWebSocket({route:msgRouteToDevice,code:2,msg:"开门！",data:''});
    }

    function closeDoor() {
        sendMsgByWebSocket({route:msgRouteToDevice,code:5,msg:"关门！",data:''});
    }

    function readCard() {
        sendMsgByWebSocket({route:msgRouteToDevice,code:15,msg:"上传卡片数据！",data:''});
    }

    function resetDevice() {
        sendMsgByWebSocket({route:msgRouteToDevice,code:9,msg:"复位设备！",data:''});
    }

    function cleanDevice() {
        sendMsgByWebSocket({route:msgRouteToDevice,code:12,msg:"清理日志信息！",data:''});
    }

    function updateEnviroData() {
        sendMsgByWebSocket({route:msgRouteToDevice,code:21,msg:"上传环境数据！",data:''});
    }

    function updataDeviceState() {
        sendMsgByWebSocket({route:msgRouteToDevice,code:24,msg:"上传门禁状态数据！",data:''});
    }

    function updateDeviceInfor() {
        sendMsgByWebSocket({route:msgRouteToDevice,code:33,msg:"上传设备信息！",data:''});
    }

    //为Echarts图获取当日环境数据，并更新数据。
    function getCurrentDayEnvirDataForEcharts(){
        $.get("http://"+document.location.host+"/getCurrentDayEnviroDataByDeviceNumberForEchart",{deviceNumber:rfidAdmin.deviceNumber},function (data,status) {
            if (status=='success'){
                if (data.code==0){
                    temperatureOption.xAxis.data=data.data.timeList;
                    humidityOption.xAxis.data=data.data.timeList;
                    lightIntensityOption.xAxis.data=data.data.timeList;

                    temperatureOption.series[0]={name:'温度', type:'line', stack: '摄氏度', data:data.data.temperatureData};
                    humidityOption.series[0]={name:'湿度', type:'line', stack: '百分比', data:data.data.humidityData};
                    lightIntensityOption.series[0]={name:'光强', type:'line', stack: '勒克斯', data:data.data.lightData};

                    temperatureCurve.setOption(temperatureOption);
                    humidityCure.setOption(humidityOption);
                    lightIntensityCurve.setOption(lightIntensityOption);
                }else {
                    alert(data.msg);
                }
            } else {
                alert(status);
            }
        });
    }

    //获取最新环境数据（用于数据统计模块）
    function getCurrentEnviroDataForDataCollection(){
        $.get("http://"+document.location.host+"/getCurrentEnviroDataByDeviceNumber",{deviceNumber:rfidAdmin.deviceNumber},function (data,status) {
            if (status=='success'){
                if (data.code==0){
                    $("#currentTemperature").text(data.data.temperature+"℃");
                    $("#currentHumidity").text(data.data.humidity+"%");
                    $("#currentLight").text(data.data.lightIntensity+"Lux");
                }else {
                    alert(data.msg);
                }
            } else {
                alert(status);
            }
        });
    }
</script>
</body>
</html>